# 폰트 사이즈 및 위치 고정 문제 분석

## 문제 요약

이전 테스트 결과물이 현재 파이프라인 결과물보다 더 나은 이유:
1. **폰트 사이즈가 고정적/제한적**: 현재 파이프라인에서 폰트 크기 범위가 너무 좁음
2. **위치가 고정적**: 항상 같은 비율(0.1, 0.05, 0.8, 0.18)로 고정됨

## 상세 분석

### 1. 폰트 크기 범위 문제

#### 이전 코드 (`old/overlay.py`)
```python
min_font_size: int = 28
max_font_size: int = 96
```
- **고정된 넓은 범위**: 28-96px
- **장점**: 텍스트에 맞게 큰 폰트도 선택 가능
- **결과**: 더 큰 폰트로 가독성 향상

#### 현재 코드 (`routers/overlay.py`)
```python
min_font_size = max(12, int(ph * 0.15))  # 영역 높이의 15%
max_font_size = min(96, int(ph * 0.4))   # 영역 높이의 40%
```

**문제점**:
1. **영역 기반 계산이 너무 제한적**:
   - 예: ph=92px (512px 이미지의 18%)인 경우
   - min = max(12, 92*0.15) = 14px
   - max = min(96, 92*0.4) = 36px
   - **범위: 14-36px (매우 좁음!)**

2. **LLaVA 추천과 교집합 시 더 좁아짐**:
   - LLaVA 추천: `medium` (24-48px)
   - 영역 기반: 14-36px
   - **교집합: 24-36px** (12px 범위만 가능!)
   - 이전 코드는 28-96px 범위에서 자유롭게 선택 가능

3. **영역이 작을수록 더 제한적**:
   - ph가 작으면 max_font_size가 더 작아짐
   - 텍스트가 길면 작은 폰트로 강제됨

### 2. 위치 고정 문제

#### 이전 코드
```python
bbox = layout.bbox.as_absolute(width, height)
```
- **LayoutOption에서 제공하는 bbox 사용**
- 다양한 위치 옵션 가능
- 이미지에 맞게 최적 위치 선택

#### 현재 코드
```python
# 기본값 (항상 고정)
x, y, pw, ph = (int(w * 0.1), int(h * 0.05), int(w * 0.8), int(h * 0.18))
```
- **고정된 비율**: x=10%, y=5%, width=80%, height=18%
- Planner proposal이 있어도 첫 번째 proposal만 사용
- **항상 같은 위치에 배치**

### 3. 실제 계산 예시

**현재 파이프라인 (512x512 이미지)**:
- 영역: x=51px, y=25px, w=409px, h=92px
- 폰트 범위 계산:
  - min = max(12, 92*0.15) = 14px
  - max = min(96, 92*0.4) = 36px
- LLaVA 추천 medium (24-48px) 적용:
  - 교집합: 24-36px
- **최종 범위: 24-36px** (12px 범위만 가능)

**이전 코드**:
- 폰트 범위: 28-96px (68px 범위)
- 더 큰 폰트 선택 가능
- 텍스트가 짧으면 큰 폰트 사용 가능

## 해결 방안

### 방안 1: 폰트 크기 범위 확대 (권장)

```python
# 현재 (너무 제한적)
min_font_size = max(12, int(ph * 0.15))
max_font_size = min(96, int(ph * 0.4))

# 개선안 1: 최소값을 더 크게
min_font_size = max(24, int(ph * 0.2))  # 최소 24px, 영역의 20%
max_font_size = min(96, int(ph * 0.6))  # 영역의 60%까지

# 개선안 2: 이전 코드처럼 고정 범위 사용 (LLaVA 추천과 교집합)
min_font_size = 28  # 이전 코드와 동일
max_font_size = 96  # 이전 코드와 동일
# LLaVA 추천이 있으면 교집합, 없으면 전체 범위 사용
```

### 방안 2: LLaVA 추천과 교집합 대신 유니온 사용

```python
# 현재: 교집합 (너무 제한적)
min_font_size = max(min_font_size, size_range[0])
max_font_size = min(max_font_size, size_range[1])

# 개선안: 영역 기반 범위를 우선하고, LLaVA 추천은 가이드로만 사용
# 또는 LLaVA 추천 범위를 더 넓게 확장
```

### 방안 3: 위치 다양화

```python
# Planner proposal의 여러 옵션을 고려
# 또는 이미지 분석 기반 최적 위치 선택
```

## 권장 수정 사항

1. **폰트 크기 범위 확대**:
   - 최소값: 24px 이상 (이전 코드와 유사)
   - 최대값: 영역의 60%까지 또는 96px
   - LLaVA 추천은 가이드로만 사용 (교집합 대신)

2. **위치 다양화**:
   - Planner proposal의 여러 옵션 고려
   - 이미지 특성에 맞는 위치 선택

3. **영역 크기 고려**:
   - 영역이 작을 때도 최소한의 가독성 보장
   - 텍스트 길이에 따라 동적 조정

